<?php
/** @var ProductAssemblyService $block */

use BIWAC\AssemblyService\Block\ProductAssemblyService;
use Magento\Framework\Exception\LocalizedException;
use Magento\Framework\Exception\NoSuchEntityException;

try {
    $assemblyProduct = $block->getProduct();
} catch (NoSuchEntityException $e) {
    echo $e->getMessage();
}

?>
<?php if (isset($assemblyProduct) && $block->getConfig()->isEnabled() && $block->hasParentAssemblyService()): ?>
    <div id="product-assembly-service" class="closed hidden">
        <form id="assembly-service" data-role="tocart-form" action="<?php try {
            echo $block->getAddToCartUrl();
        } catch (NoSuchEntityException $e) {
        } ?>" method="post">
            <!-- <h3><?php echo $assemblyProduct->getName(); ?></h3> -->
            <?php
            # Image
            $imageUrl = '';
            if ($assemblyProduct->getImage()) {
                $imageHelper = $block->getLayout()->createBlock('Magento\Catalog\Block\Product\Image');
                $imageUrl = $imageHelper->setImageFile($assemblyProduct->getImage())->getUrl();
            }
            ?>
            <?php if ($imageUrl): ?>
                <img src="<?php echo $imageUrl; ?>" alt="<?php echo $assemblyProduct->getName(); ?>" />
            <?php endif;?>
            <input type="hidden" id="current-product-id" value="<?php echo $block->getParentProduct()->getId(); ?>">
            <div class="price-box price-final_price"
                 data-role="priceBox"
                 data-product-id="<?php echo $assemblyProduct->getId() ?>"
                 data-price-box="product-id-<?php echo $assemblyProduct->getId() ?>">
                <span class="price" id="price-boxer"><?php echo $block->getPriceFormattted($assemblyProduct->getPrice()); ?></span>
            </div>
            <div class="product-options-wrapper" id="product-options-wrapper">
                <?php $x = 0;?>
                <?php foreach ($assemblyProduct->getOptions() as $option) : ?>
                    <?php if ($block->getParentProduct()->getData('product_class') && $option->getTitle() == 'Postcode'): ?>
                            <label>Postcode: </label>
                            <input type="text"
                               id="postcode"
                               name="options[<?php echo $option->getId(); ?>]"
                               value="<?php echo $block->getOptionValues()[$x];?>"
                               width="5"
                               minlength="5"
                               maxlength="5"
                               style="width: 80px"
                        />
                        <span class="postcode-price" style="margin-left: 10px;"></span>
                    <?php elseif ($block->getOptionValues()[$x]): ?>
                        <input type="hidden"
                               id="option_<?php echo $option->getId(); ?>"
                               name="options[<?php echo $option->getId(); ?>]"
                               value="<?php echo $block->getOptionValues()[$x];?>"
                        />
                    <?php endif; ?>
                <?php ++$x; ?>
                <?php endforeach; ?>
            </div>
            <?php echo $block->getBlockHtml('formkey') ?>
            <div class="btn" style="margin-top: 20px;">
                <button id="assembly-cart-add" type="submit" title="Add to Cart" class="action tocart primary">
                    <span><?php echo __('Add to Cart'); ?></span>
                </button>
            </div>
        </form>
    </div>
<?php endif; ?>
<script type="text/x-magento-init">
    {
        "*": {
            "BIWAC_AssemblyService/js/postcode" : {},
            "BIWAC_AssemblyService/js/added-to-cart" : {}
        }
    }
</script>
<script type="javascript">
    require(['jquery', 'postcode'], function($, postcode) {
        postcode();
    });
</script>
